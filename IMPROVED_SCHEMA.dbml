// =====================================================
// ENTERPRISE FINANCIAL DATA PLATFORM SCHEMA - IMPROVED
// Total Tables: 52 (Enhanced from 38)
// Layer A: 22 | Layer B: 14 | Layer C: 16
// =====================================================
// 
// IMPROVEMENTS MADE:
// 1. Fixed field name mismatches with codebase
// 2. Added missing fields used in code
// 3. Added proper indexes for performance
// 4. Fixed foreign key relationships
// 5. Standardized naming conventions
// =====================================================

// =====================================================
// LAYER A: FLOW & CONTROL (22 TABLES)
// Infrastructure, Authentication, Consent Management
// =====================================================

// A1: INFRASTRUCTURE & PROVIDER MANAGEMENT

Table tsp_providers {
  id uuid [pk]
  name varchar(100) [not null]
  environment varchar(20) [not null]
  base_url text [not null]
  api_version varchar(20)
  rate_limit_per_minute integer [default: 60]
  rate_limit_per_hour integer [default: 1000]
  timeout_seconds integer [default: 30]
  retry_config jsonb
  is_active boolean [default: true]
  metadata jsonb
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  updated_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (name, environment) [unique, name: 'unique_tsp_provider']
    (is_active, environment) [name: 'idx_tsp_providers_active']
  }
}

Table aa_gateways {
  id uuid [pk]
  name varchar(100) [not null]
  environment varchar(20) [not null]
  gateway_base_url text [not null]
  api_version varchar(20)
  supported_fi_types "text[]"
  rate_limit_per_minute integer [default: 60]
  timeout_seconds integer [default: 30]
  is_active boolean [default: true]
  metadata jsonb
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  updated_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (name, environment) [unique, name: 'unique_aa_gateway']
    (is_active, environment) [name: 'idx_aa_gateways_active']
  }
}

Table fips {
  id uuid [pk]
  fip_id varchar(120) [unique, not null]
  fip_name varchar(255) [not null]
  code varchar(50)
  type varchar(50) [not null]
  is_enabled boolean [default: true]
  fi_types jsonb
  entity_icon_uri varchar(500)
  entity_logo_uri varchar(500)
  entity_logo_with_name_uri varchar(500)
  otp_length integer
  support_email varchar(255)
  support_phone varchar(20)
  environment varchar(20)
  is_active boolean [default: true]
  metadata jsonb
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  updated_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (fip_id) [name: 'idx_fips_fip_id']
    (type, is_active) [name: 'idx_fips_type']
    (is_enabled) [name: 'idx_fips_enabled']
    (code) [name: 'idx_fips_code']
  }
}

Table brokers {
  id uuid [pk]
  broker_id varchar(50) [unique, not null]
  broker_name varchar(100) [not null]
  broker_code varchar(50)
  logo_url varchar(500)
  is_active boolean [default: true]
  metadata jsonb
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (broker_id) [name: 'idx_brokers_broker_id']
    (broker_name) [name: 'idx_brokers_name']
  }
}

Table mutual_fund_schemes {
  id uuid [pk]
  code integer [unique]
  amc varchar(100)
  scheme_name varchar(255) [not null]
  scheme_structure varchar(50)
  scheme_type varchar(50)
  scheme_category varchar(100)
  scheme_nav_name varchar(255)
  launch_date date
  closure_date date
  isin varchar(20)
  logo_url varchar(500)
  is_active boolean [default: true]
  metadata jsonb
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (amc, scheme_name) [name: 'idx_mf_schemes_amc']
    (isin) [name: 'idx_mf_schemes_isin']
  }
}

// A2: USER MANAGEMENT & SUBSCRIPTIONS

Table app_users {
  id uuid [pk]
  unique_identifier varchar(50) [unique, not null]
  phone varchar(20)
  email varchar(255)
  pan varchar(10)
  email_verified boolean [default: false]
  phone_verified boolean [default: false]
  pan_verified boolean [default: false]
  status varchar(20) [default: 'ACTIVE']
  subscription_status varchar(50)
  subscription_start_date timestamptz
  subscription_end_date timestamptz
  last_login_at timestamptz
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  updated_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (unique_identifier) [name: 'idx_app_users_unique_id']
    (phone) [unique, name: 'idx_app_users_phone']
    (email) [unique, name: 'idx_app_users_email']
    (pan) [unique, name: 'idx_app_users_pan']
    (status) [name: 'idx_app_users_status']
  }
}

Table user_subscriptions {
  id uuid [pk]
  user_id uuid [ref: > app_users.id, not null]
  subscription_plan varchar(50) [not null]
  subscription_status varchar(20) [not null, default: 'ACTIVE']
  billing_cycle varchar(20)
  subscription_start timestamptz [not null]
  subscription_end timestamptz
  trial_end_date timestamptz
  auto_renew boolean [default: true]
  payment_method varchar(50)
  amount "numeric(10,2)"
  currency varchar(3) [default: 'INR']
  features_enabled jsonb
  usage_limits jsonb
  metadata jsonb
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  updated_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (user_id, subscription_status) [name: 'idx_user_subscriptions_user']
    (subscription_status, subscription_end) [name: 'idx_user_subscriptions_status']
    (subscription_end) [name: 'idx_user_subscriptions_expiry']
  }
}

Table subscription_usage_logs {
  id uuid [pk]
  subscription_id uuid [ref: > user_subscriptions.id, not null]
  user_id uuid [ref: > app_users.id, not null]
  feature_name varchar(100) [not null]
  usage_count integer [default: 1]
  usage_date date [not null, default: `CURRENT_DATE`]
  metadata jsonb
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (subscription_id, usage_date) [name: 'idx_subscription_usage_logs_date']
    (subscription_id, feature_name, usage_date) [name: 'idx_subscription_usage_logs_feature']
  }
}

// A3: APP AUTHENTICATION & TOKEN MANAGEMENT

Table app_integration_apps {
  id uuid [pk]
  tsp_id uuid [ref: > tsp_providers.id, not null]
  app_name varchar(100) [not null]
  tsp_user_id varchar(255) [not null]
  credential_ref text [not null]
  is_active boolean [default: true]
  last_auth_success_at timestamptz
  last_auth_failure_at timestamptz
  consecutive_failures integer [default: 0]
  metadata jsonb
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  updated_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (tsp_id, app_name) [unique, name: 'unique_app_tsp']
    (tsp_id, tsp_user_id) [unique, name: 'unique_app_tsp_user']
    (tsp_id, is_active) [name: 'idx_app_integration_active']
  }
}

Table tsp_auth_tokens {
  id uuid [pk]
  app_id uuid [ref: > app_integration_apps.id, not null]
  token_type varchar(30) [not null, default: 'BEARER']
  access_token text [not null]
  refresh_token text
  token_hash varchar(100) [unique, not null]
  issued_at timestamptz [not null]
  expires_at timestamptz [not null]
  expires_in integer
  refresh_token_expires_at timestamptz
  status varchar(20) [not null, default: 'ACTIVE']
  last_used_at timestamptz
  use_count integer [default: 0]
  metadata jsonb
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (app_id, status, expires_at) [name: 'idx_tsp_auth_tokens_app']
    (status, expires_at) [name: 'idx_tsp_auth_tokens_status']
    (token_hash) [name: 'idx_tsp_auth_tokens_hash']
  }
}

Table tsp_auth_token_rotation_history {
  id uuid [pk]
  app_id uuid [ref: > app_integration_apps.id, not null]
  old_token_id uuid
  new_token_id uuid [ref: > tsp_auth_tokens.id]
  rotation_reason varchar(100)
  rotation_type varchar(30)
  rotated_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (app_id, rotated_at) [name: 'idx_token_rotation_app']
  }
}

// A4: API CALL TRACKING & RATE LIMITING

Table tsp_api_calls {
  id uuid [pk]
  tsp_id uuid [ref: > tsp_providers.id, not null]
  app_id uuid [ref: > app_integration_apps.id]
  token_id uuid [ref: > tsp_auth_tokens.id]
  user_id uuid [ref: > app_users.id]
  request_tag varchar(50) [not null]
  http_method varchar(10) [not null]
  endpoint text [not null]
  request_id varchar(150) [unique, not null]
  status_code integer
  request_payload jsonb
  response_payload jsonb
  response_size_bytes integer
  error_code varchar(100)
  error_message text
  retry_count integer [default: 0]
  started_at timestamptz [not null]
  completed_at timestamptz
  duration_ms integer
  
  indexes {
    (tsp_id, started_at) [name: 'idx_tsp_api_calls_tsp']
    (app_id, started_at) [name: 'idx_tsp_api_calls_app']
    (user_id, started_at) [name: 'idx_tsp_api_calls_user']
    (request_tag, started_at) [name: 'idx_tsp_api_calls_tag']
    (status_code, started_at) [name: 'idx_tsp_api_calls_status']
  }
}

Table api_rate_limits {
  id uuid [pk]
  user_id uuid [ref: > app_users.id]
  app_id uuid [ref: > app_integration_apps.id]
  tsp_id uuid [ref: > tsp_providers.id]
  limit_type varchar(30) [not null]
  endpoint_pattern varchar(255)
  request_count integer [default: 0]
  window_start timestamptz [not null]
  window_end timestamptz [not null]
  limit_threshold integer [not null]
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (user_id, window_end) [name: 'idx_api_rate_limits_user']
    (app_id, window_end) [name: 'idx_api_rate_limits_app']
    (tsp_id, window_end) [name: 'idx_api_rate_limits_tsp']
  }
}

// A5: CONSENT MANAGEMENT FLOW

Table aa_consent_requests {
  id uuid [pk]
  user_id uuid [ref: > app_users.id, not null]
  tsp_id uuid [ref: > tsp_providers.id, not null]
  aa_gateway_id uuid [ref: > aa_gateways.id, not null]
  unique_identifier varchar(50) [not null]
  aa_cust_id varchar(120)
  template_name varchar(100) [not null]
  user_session_id varchar(150)
  redirect_url text
  encrypted_request text
  consent_handle varchar(150)
  consent_url text
  request_id varchar(150) [unique, not null]
  consent_purpose text
  consent_description text
  request_consent_id varchar(150)
  date_range_from timestamptz
  date_range_to timestamptz
  aa_id varchar(50)
  fetch_type varchar(20)
  frequency_unit varchar(20)
  frequency_value integer
  data_life_unit varchar(20)
  data_life_value integer
  fi_types "text[]"
  status varchar(40) [not null, default: 'CREATED']
  error_code varchar(100)
  error_message text
  expires_at timestamptz
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  updated_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (user_id, created_at) [name: 'idx_aa_consent_requests_user']
    (status, created_at) [name: 'idx_aa_consent_requests_status']
    (consent_handle) [name: 'idx_aa_consent_requests_handle']
  }
}

Table aa_redirect_events {
  id uuid [pk]
  consent_request_id uuid [ref: > aa_consent_requests.id, not null]
  event_type varchar(30) [not null]
  redirect_state varchar(200)
  callback_status varchar(30)
  callback_params jsonb
  user_agent text
  ip_address inet
  occurred_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (consent_request_id, occurred_at) [name: 'idx_aa_redirect_events_consent']
    (event_type, occurred_at) [name: 'idx_aa_redirect_events_type']
  }
}

Table aa_consents {
  id uuid [pk]
  user_id uuid [ref: > app_users.id, not null]
  tsp_id uuid [ref: > tsp_providers.id, not null]
  aa_gateway_id uuid [ref: > aa_gateways.id, not null]
  consent_request_id uuid [ref: > aa_consent_requests.id]
  consent_handle varchar(150) [unique, not null]
  consent_id varchar(150)
  template_name varchar(100)
  consent_mode varchar(20)
  consent_types jsonb
  purpose_code varchar(20)
  fi_types "text[]"
  data_life_unit varchar(20)
  data_life_value integer
  frequency_unit varchar(20)
  frequency_value integer
  data_filter jsonb
  consent_start timestamptz
  consent_expiry timestamptz
  fetch_count integer [default: 0]
  last_fetch_at timestamptz
  status varchar(30) [not null, default: 'PENDING']
  status_reason text
  revocation_reason text
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  activated_at timestamptz
  revoked_at timestamptz
  expired_at timestamptz
  updated_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (user_id, status, created_at) [name: 'idx_aa_consents_user']
    (status, consent_expiry) [name: 'idx_aa_consents_status']
    (user_id, status) [name: 'idx_aa_consents_active']
  }
}

Table aa_consent_events {
  id uuid [pk]
  consent_id uuid [ref: > aa_consents.id, not null]
  event_type varchar(30) [not null]
  event_source varchar(50)
  triggered_by varchar(50)
  raw_payload jsonb
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (consent_id, created_at) [name: 'idx_aa_consent_events_consent']
    (event_type, created_at) [name: 'idx_aa_consent_events_type']
  }
}

// A6: DATA FETCH OPERATIONS

Table aa_data_fetch_runs {
  id uuid [pk]
  user_id uuid [ref: > app_users.id, not null]
  tsp_id uuid [ref: > tsp_providers.id, not null]
  consent_id uuid [ref: > aa_consents.id, not null]
  consent_handle varchar(150) [not null]
  fetch_type varchar(60) [not null]
  endpoint text [not null]
  request_id varchar(150) [unique, not null]
  session_id varchar(150)
  total_fi_data integer [default: 0]
  total_fi_data_to_fetch integer
  fi_data_fetched integer [default: 0]
  last_fetch_date timestamptz
  date_range_from timestamptz
  date_range_to timestamptz
  status varchar(30) [not null, default: 'INITIATED']
  error_code varchar(100)
  error_message text
  retry_count integer [default: 0]
  requested_at timestamptz [not null]
  fetched_at timestamptz
  parsed_at timestamptz
  completed_at timestamptz
  records_count integer [default: 0]
  metadata jsonb
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  updated_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (user_id, requested_at) [name: 'idx_aa_data_fetch_runs_user']
    (consent_id, requested_at) [name: 'idx_aa_data_fetch_runs_consent']
    (status, requested_at) [name: 'idx_aa_data_fetch_runs_status']
    (fetch_type, requested_at) [name: 'idx_aa_data_fetch_runs_type']
  }
}

Table aa_fetch_payloads {
  id uuid [pk]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id, not null]
  fip_id varchar(100)
  account_ref_number varchar(255)
  fi_type varchar(50)
  raw_payload jsonb [not null]
  payload_role varchar(20)
  content_format varchar(20)
  storage_ref text
  compression_type varchar(20)
  file_size_bytes bigint
  hash_sha256 varchar(80)
  encryption_key_ref varchar(100)
  decrypted_at timestamptz
  processed_at timestamptz
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (fetch_run_id) [name: 'idx_aa_fetch_payloads_run']
    (fetch_run_id, payload_role) [name: 'idx_aa_fetch_payloads_run_role']
    (hash_sha256) [name: 'idx_aa_fetch_payloads_hash']
    (fip_id, fi_type) [name: 'idx_aa_fetch_payloads_fip']
  }
}

// A7: MFC & ALTERNATE CONSENT FLOWS

Table mfc_consent_requests {
  id uuid [pk]
  user_id uuid [ref: > app_users.id, not null]
  pan varchar(10) [not null]
  client_reference_id varchar(100) [unique, not null]
  client_ref_no varchar(100)
  consent_mode varchar(20) [default: 'CAMS_VERIFIED']
  otp_validated boolean [default: false]
  otp_sent_at timestamptz
  otp_attempts integer [default: 0]
  validation_method varchar(50)
  status varchar(30) [not null, default: 'INITIATED']
  error_code varchar(100)
  error_message text
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  updated_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (user_id, created_at) [name: 'idx_mfc_consent_requests_user']
    (pan) [name: 'idx_mfc_consent_requests_pan']
    (status) [name: 'idx_mfc_consent_requests_status']
  }
}

// =====================================================
// LAYER B: CANONICAL FINANCIAL DATA (14 TABLES)
// FIPs, Accounts, Transactions with full API mapping
// =====================================================

Table fi_accounts {
  id uuid [pk]
  user_id uuid [ref: > app_users.id, not null]
  consent_id uuid [ref: > aa_consents.id]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id]
  fip_id uuid [ref: > fips.id]
  fi_data_id varchar(100) [unique]
  fi_type varchar(50) [not null]
  account_name varchar(100)
  masked_acc_no varchar(255)
  account_ref_number varchar(255)
  linked_acc_ref varchar(255)
  fip_account_type varchar(50)
  fip_account_sub_type varchar(50)
  provider_name varchar(255)
  fip_id_str varchar(100)
  fip_name varchar(255)
  data_fetched boolean [default: false]
  last_fetch_datetime timestamptz
  latest_consent_purpose_text text
  latest_consent_expiry_time timestamptz
  consent_purpose_version varchar(20)
  fi_data jsonb
  version varchar(50)
  account_ref_hash varchar(100) [unique]
  last_seen_at timestamptz
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  updated_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (user_id, created_at) [name: 'idx_fi_accounts_user']
    (consent_id) [name: 'idx_fi_accounts_consent']
    (fetch_run_id) [name: 'idx_fi_accounts_fetch_run']
    (fip_id, fi_type) [name: 'idx_fi_accounts_fip_type']
    (fi_type) [name: 'idx_fi_accounts_type']
    (fi_data_id) [name: 'idx_fi_accounts_fi_data_id']
    (account_ref_number) [name: 'idx_fi_accounts_account_ref']
    (account_ref_hash) [name: 'idx_fi_accounts_ref_hash']
  }
}

Table fi_account_holders_pii {
  id uuid [pk]
  account_id uuid [ref: > fi_accounts.id, not null]
  holders_type varchar(50)
  name varchar(255)
  dob date
  mobile varchar(50)
  email varchar(255)
  pan varchar(20)
  address text
  ckycregno varchar(50)
  kyc_compliance varchar(50)
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (account_id) [name: 'idx_fi_account_holders_account']
    (pan) [name: 'idx_fi_account_holders_pan']
    (mobile) [name: 'idx_fi_account_holders_mobile']
  }
}

Table fi_transactions {
  id uuid [pk]
  account_id uuid [ref: > fi_accounts.id, not null]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id]
  txn_id varchar(255)
  txn_type varchar(50)
  mode varchar(50)
  amount "numeric(18,2)"
  balance "numeric(18,2)"
  current_balance "numeric(18,2)"
  txn_timestamp timestamptz
  transaction_timestamp timestamptz
  value_date date
  narration text
  reference varchar(255)
  category varchar(50)
  sub_category varchar(50)
  merchant_name varchar(255)
  merchant_category varchar(100)
  txn_mode varchar(50)
  dedupe_hash varchar(100)
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (account_id, transaction_timestamp) [name: 'idx_fi_transactions_account_time']
    (account_id, txn_timestamp) [name: 'idx_fi_transactions_account_txn_time']
    (fetch_run_id) [name: 'idx_fi_transactions_fetch_run']
    (txn_id) [name: 'idx_fi_transactions_txn_id']
    (account_id, dedupe_hash) [unique, name: 'unique_fi_transaction']
    (txn_type) [name: 'idx_fi_transactions_type']
  }
}

Table fi_mf_transactions {
  id uuid [pk]
  account_id uuid [ref: > fi_accounts.id, not null]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id]
  txn_id varchar(255)
  isin varchar(20)
  isin_description text
  amc varchar(100)
  amfi_code varchar(20)
  registrar varchar(50)
  folio_no varchar(50)
  nav "numeric(18,8)"
  nav_date date
  units "numeric(24,8)"
  amount "numeric(18,2)"
  type varchar(20)
  mode varchar(20)
  narration text
  lock_in_days varchar(10)
  lock_in_flag varchar(5)
  stt_tax "numeric(10,2)"
  tax "numeric(10,2)"
  total_tax "numeric(10,2)"
  stamp_duty "numeric(10,2)"
  txn_charge "numeric(10,2)"
  data_source varchar(20)
  txn_datetime timestamptz
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (account_id, txn_datetime) [name: 'idx_fi_mf_transactions_account']
    (isin, txn_datetime) [name: 'idx_fi_mf_transactions_isin']
    (folio_no) [name: 'idx_fi_mf_transactions_folio']
  }
}

Table fi_equity_transactions {
  id uuid [pk]
  account_id uuid [ref: > fi_accounts.id, not null]
  broker_id uuid [ref: > brokers.id]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id]
  txn_id varchar(255)
  order_id varchar(100)
  isin varchar(20)
  isin_description text
  company_name varchar(255)
  type varchar(20)
  units "numeric(24,8)"
  rate "numeric(18,4)"
  equity_category varchar(50)
  exchange varchar(20)
  narration text
  txn_datetime timestamptz
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (account_id, txn_datetime) [name: 'idx_fi_equity_transactions_account']
    (isin, txn_datetime) [name: 'idx_fi_equity_transactions_isin']
    (order_id) [name: 'idx_fi_equity_transactions_order']
  }
}

Table fi_etf_transactions {
  id uuid [pk]
  account_id uuid [ref: > fi_accounts.id, not null]
  broker_id uuid [ref: > brokers.id]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id]
  txn_id varchar(255)
  isin varchar(20)
  isin_description text
  type varchar(20)
  units "numeric(24,8)"
  nav "numeric(18,8)"
  narration text
  txn_datetime timestamptz
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (account_id, txn_datetime) [name: 'idx_fi_etf_transactions_account']
    (isin, txn_datetime) [name: 'idx_fi_etf_transactions_isin']
  }
}

// =====================================================
// LAYER C: FINANCIAL STATE & HOLDINGS (16 TABLES)
// Summaries, Holdings, Insights with full API mapping
// =====================================================

// C1: DEPOSIT SUMMARIES

Table fi_deposit_summaries {
  id uuid [pk]
  account_id uuid [ref: > fi_accounts.id, not null]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id]
  current_balance "numeric(18,2)"
  available_balance "numeric(18,2)"
  currency varchar(10)
  balance_datetime timestamptz
  last_fetch_time timestamptz
  account_type varchar(50)
  account_sub_type varchar(50)
  branch varchar(255)
  ifsc varchar(20)
  ifsc_code varchar(20)
  micr_code varchar(20)
  opening_date date
  status varchar(50)
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (account_id) [unique, name: 'idx_fi_deposit_summaries_account']
    (balance_datetime) [name: 'idx_fi_deposit_summaries_datetime']
  }
}

Table fi_term_deposit_summaries {
  id uuid [pk]
  account_id uuid [ref: > fi_accounts.id, not null]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id]
  principal_amount "numeric(18,2)"
  current_balance "numeric(18,2)"
  maturity_amount "numeric(18,2)"
  maturity_date date
  interest_rate "numeric(9,4)"
  interest_payout varchar(50)
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (account_id) [unique, name: 'idx_fi_term_deposit_summaries_account']
    (maturity_date) [name: 'idx_fi_term_deposit_summaries_maturity']
  }
}

Table fi_recurring_deposit_summaries {
  id uuid [pk]
  account_id uuid [ref: > fi_accounts.id, not null]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id]
  current_balance "numeric(18,2)"
  maturity_amount "numeric(18,2)"
  maturity_date date
  interest_rate "numeric(9,4)"
  recurring_amount "numeric(18,2)"
  tenure_months integer
  recurring_day integer
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (account_id) [unique, name: 'idx_fi_recurring_deposit_summaries_account']
    (maturity_date) [name: 'idx_fi_recurring_deposit_summaries_maturity']
  }
}

// C2: MUTUAL FUND DATA

Table fi_mutual_fund_summaries {
  id uuid [pk]
  account_id uuid [ref: > fi_accounts.id, not null]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id]
  cost_value "numeric(18,2)"
  current_value "numeric(18,2)"
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (account_id) [unique, name: 'idx_fi_mutual_fund_summaries_account']
  }
}

Table fi_mutual_fund_holdings {
  id uuid [pk]
  account_id uuid [ref: > fi_accounts.id, not null]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id]
  amc varchar(255)
  scheme_name varchar(255)
  scheme_code varchar(100)
  scheme_plan varchar(50)
  scheme_option varchar(50)
  registrar varchar(100)
  scheme_types varchar(50)
  scheme_category varchar(100)
  isin varchar(50)
  isin_description text
  ucc varchar(50)
  amfi_code varchar(20)
  folio_no varchar(255)
  closing_units "numeric(24,8)"
  lien_units "numeric(24,8)"
  locking_units "numeric(24,8)"
  units "numeric(24,8)"
  nav "numeric(18,8)"
  avg_nav "numeric(18,8)"
  nav_date date
  current_value "numeric(18,2)"
  cost_value "numeric(18,2)"
  last_fetch_time timestamptz
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (account_id) [name: 'idx_fi_mutual_fund_holdings_account']
    (isin) [name: 'idx_fi_mutual_fund_holdings_isin']
    (folio_no) [name: 'idx_fi_mutual_fund_holdings_folio']
  }
}

Table fi_mutual_fund_txn_details {
  id uuid [pk]
  transaction_id uuid [ref: > fi_transactions.id, unique, not null]
  isin varchar(50)
  scheme_name varchar(255)
  amc varchar(255)
  folio_no varchar(255)
  nav "numeric(18,8)"
  nav_date date
  units "numeric(24,8)"
  lockin_flag boolean
  lockin_days integer
  
  indexes {
    (isin) [name: 'idx_fi_mutual_fund_txn_details_isin']
    (folio_no) [name: 'idx_fi_mutual_fund_txn_details_folio']
  }
}

Table fi_mf_holding_prev_details {
  id uuid [pk]
  holding_id uuid [ref: > fi_mutual_fund_holdings.id, not null]
  percentage_change "numeric(10,4)"
  price_change "numeric(18,4)"
  last_fetch_time timestamptz
  holding_isin varchar(20)
  total_units "numeric(24,8)"
  current_value "numeric(18,2)"
  snapshot_date date
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (holding_id, snapshot_date) [name: 'idx_fi_mf_holding_prev_holding']
  }
}

// C3: EQUITY DATA

Table fi_equity_summaries {
  id uuid [pk]
  account_id uuid [ref: > fi_accounts.id, not null]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id]
  current_value "numeric(18,2)"
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (account_id) [unique, name: 'idx_fi_equity_summaries_account']
  }
}

Table fi_equity_holdings {
  id uuid [pk]
  account_id uuid [ref: > fi_accounts.id, not null]
  broker_id uuid [ref: > brokers.id]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id]
  demat_id varchar(100)
  broker_name varchar(255)
  issuer_name varchar(255)
  isin varchar(50)
  isin_desc text
  isin_description text
  units "numeric(24,8)"
  last_price "numeric(18,4)"
  last_traded_price "numeric(18,4)"
  avg_traded_price "numeric(18,4)"
  current_value "numeric(18,2)"
  portfolio_weightage_pct "numeric(8,4)"
  last_fetch_time timestamptz
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (account_id) [name: 'idx_fi_equity_holdings_account']
    (isin) [name: 'idx_fi_equity_holdings_isin']
    (demat_id) [name: 'idx_fi_equity_holdings_demat']
  }
}

Table fi_equity_txn_details {
  id uuid [pk]
  transaction_id uuid [ref: > fi_transactions.id, unique, not null]
  order_id varchar(100)
  exchange varchar(50)
  isin varchar(50)
  company_name varchar(255)
  rate "numeric(18,4)"
  units "numeric(24,8)"
  
  indexes {
    (order_id) [name: 'idx_fi_equity_txn_details_order']
    (isin) [name: 'idx_fi_equity_txn_details_isin']
  }
}

// C4: ETF DATA

Table fi_etf_holdings {
  id uuid [pk]
  account_id uuid [ref: > fi_accounts.id, not null]
  broker_id uuid [ref: > brokers.id]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id]
  demat_id varchar(100)
  broker_name varchar(255)
  isin varchar(50)
  isin_description text
  units "numeric(24,8)"
  nav "numeric(18,8)"
  current_value "numeric(18,2)"
  last_fetch_time timestamptz
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (account_id) [name: 'idx_fi_etf_holdings_account']
    (isin) [name: 'idx_fi_etf_holdings_isin']
  }
}

// C5: NPS DATA

Table fi_nps_summaries {
  id uuid [pk]
  account_id uuid [ref: > fi_accounts.id, unique, not null]
  fetch_run_id uuid [ref: > aa_data_fetch_runs.id]
  pran varchar(20)
  tier_type varchar(10)
  scheme_name varchar(255)
  scheme_nav "numeric(18,4)"
  nav_date date
  units "numeric(18,6)"
  current_value "numeric(18,2)"
  employee_contribution "numeric(18,2)"
  employer_contribution "numeric(18,2)"
  voluntary_contribution "numeric(18,2)"
  total_contribution "numeric(18,2)"
  as_of_date timestamptz
  last_fetch_time timestamptz
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  updated_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (account_id) [name: 'idx_fi_nps_summaries_account']
    (pran) [name: 'idx_fi_nps_summaries_pran']
  }
}

Table fi_nps_holdings {
  id uuid [pk]
  user_id uuid [ref: > app_users.id, not null]
  summary_id uuid [ref: > fi_nps_summaries.id]
  pran varchar(20)
  scheme_name varchar(255)
  scheme_type varchar(50)
  pfm_name varchar(255)
  units "numeric(18,6)"
  nav "numeric(18,4)"
  current_value "numeric(18,2)"
  total_contribution "numeric(18,2)"
  tier1_value "numeric(18,2)"
  tier2_value "numeric(18,2)"
  fip_name varchar(255)
  last_fetch_time timestamptz
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  updated_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (user_id) [name: 'idx_fi_nps_holdings_user']
    (summary_id) [name: 'idx_fi_nps_holdings_summary']
    (pran) [name: 'idx_fi_nps_holdings_pran']
  }
}

// C6: INSIGHTS & ANALYTICS

Table fi_mf_insights {
  id uuid [pk]
  user_id uuid [ref: > app_users.id, not null]
  pan varchar(10)
  mobile varchar(20)
  total_holdings integer
  current_value "numeric(18,2)"
  invested_value "numeric(18,2)"
  absolute_return "numeric(18,2)"
  absolute_return_pct "numeric(10,4)"
  xirr "numeric(10,4)"
  daily_returns "numeric(18,2)"
  daily_returns_pct "numeric(10,4)"
  category_distribution jsonb
  subcategory_distribution jsonb
  market_cap_distribution jsonb
  amc_distribution jsonb
  sector_distribution jsonb
  snapshot_date date
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (user_id, snapshot_date) [name: 'idx_fi_mf_insights_user']
    (pan, snapshot_date) [name: 'idx_fi_mf_insights_pan']
  }
}

Table fi_equity_insights {
  id uuid [pk]
  user_id uuid [ref: > app_users.id, not null]
  current_value "numeric(18,2)"
  total_holdings integer
  total_demats integer
  daily_returns "numeric(18,2)"
  daily_returns_pct "numeric(10,4)"
  demat_wise_distribution jsonb
  sector_distribution jsonb
  market_cap_distribution jsonb
  snapshot_date date
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (user_id, snapshot_date) [name: 'idx_fi_equity_insights_user']
  }
}

Table fi_etf_insights {
  id uuid [pk]
  user_id uuid [ref: > app_users.id, not null]
  current_value "numeric(18,2)"
  total_holdings integer
  total_demats integer
  daily_returns "numeric(18,2)"
  daily_returns_pct "numeric(10,4)"
  demat_wise_distribution jsonb
  snapshot_date date
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (user_id, snapshot_date) [name: 'idx_fi_etf_insights_user']
  }
}

Table fi_deposit_insights {
  id uuid [pk]
  user_id uuid [ref: > app_users.id, not null]
  account_ids "uuid[]"
  period_from date
  period_to date
  frequency varchar(20)
  balance_data jsonb
  outgoing_data jsonb
  incoming_data jsonb
  snapshot_date date
  created_at timestamptz [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (user_id, snapshot_date) [name: 'idx_fi_deposit_insights_user']
  }
}

// C7: DASHBOARD SNAPSHOTS

Table user_financial_snapshots {
  id uuid [pk]
  user_id uuid [ref: > app_users.id, not null]
  consent_id uuid [ref: > aa_consents.id]
  snapshot_type varchar(50)
  snapshot jsonb
  total_net_worth "numeric(18,2)"
  deposits_value "numeric(18,2)"
  term_deposits_value "numeric(18,2)"
  recurring_deposits_value "numeric(18,2)"
  mutual_funds_value "numeric(18,2)"
  equities_value "numeric(18,2)"
  etf_value "numeric(18,2)"
  nps_value "numeric(18,2)"
  total_accounts integer
  last_fetch_date timestamptz
  generated_at timestamptz
  snapshot_at timestamptz
  
  indexes {
    (user_id, generated_at) [name: 'idx_user_financial_snapshots_user']
    (snapshot_type, generated_at) [name: 'idx_user_financial_snapshots_type']
  }
}

